<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XCVI SIMILARITY | Wanz Official — Panel</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1: #030303;
      --accent: #00ff9c;
      --accent-weak: rgba(0,255,156,0.12);
      --danger: #ff5050;
      --glass: rgba(255,255,255,0.03);
      --glass-strong: rgba(0,0,0,0.6);
      --muted: #9ee9c8;
      --card-radius: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, "Share Tech Mono", monospace;background:
      radial-gradient(circle at 20% 10%, #071017 0%, transparent 18%),
      radial-gradient(circle at 80% 90%, #09140b 0%, transparent 18%),
      linear-gradient(180deg,#000000 0%, #060606 100%);
      color:var(--muted); -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}

    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:36px;
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 360px;
      gap:28px;
      align-items:start;
    }

    /* LEFT CARD: main controls */
    .card {
      width:420px;
      border-radius:var(--card-radius);
      padding:22px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(0,255,156,0.06);
      box-shadow: 0 8px 28px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
      position:relative;
      overflow:hidden;
    }

    /* fancy animated header */
    .title {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:6px;
    }
    .logo {
      width:54px;height:54px;border-radius:10px;
      background:linear-gradient(135deg,#001f12,#003d24);
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(0,255,156,0.12);
      box-shadow: 0 6px 18px rgba(0,255,156,0.03), inset 0 -6px 18px rgba(0,0,0,0.5);
      transform:rotate(-6deg);
    }
    .logo svg{filter:drop-shadow(0 6px 18px rgba(0,255,156,0.06))}

    h1{font-size:18px;margin:0;color:var(--accent);letter-spacing:1px}
    .muted {font-size:12px;color: #9df0c8;opacity:0.9;margin-top:2px}

    .meta-row{display:flex;gap:8px;align-items:center;margin-top:14px}
    .pill {
      padding:8px 10px;border-radius:8px;background:var(--glass);
      border:1px solid rgba(255,255,255,0.02); font-size:13px;color:var(--muted)
    }

    /* form */
    label{display:block;margin-top:12px;font-size:12px;color:#bfffe4}
    input, textarea, select {
      width:100%;padding:10px;border-radius:8px;margin-top:6px;
      background:var(--glass-strong);border:1px solid rgba(0,255,156,0.06);color:var(--accent);
      font-family: 'Share Tech Mono', monospace;font-size:13px;
    }
    textarea{height:70px;resize:none}

    .row{display:flex;gap:10px;align-items:center;margin-top:12px}
    .btn{
      padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);
      cursor:pointer;font-weight:600;font-size:13px;background:transparent;color:var(--muted)
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(90deg, rgba(0,255,156,0.06), rgba(0,255,156,0.02)); color:var(--accent);border:1px solid rgba(0,255,156,0.12)}
    .btn-ghost{border:1px solid rgba(255,80,80,0.08);color:var(--danger)}

    .code-block{font-family:'Share Tech Mono',monospace;background:rgba(0,0,0,0.5);padding:10px;border-radius:8px;margin-top:12px;border:1px dashed rgba(0,255,156,0.06);color:#fff}

    .status {
      display:flex;align-items:center;gap:10px;margin-top:16px;
      justify-content:space-between;
    }
    .status-left{display:flex;gap:8px;align-items:center}
    .status-dot{width:12px;height:12px;border-radius:50%;background:#444;border:1px solid rgba(0,0,0,0.4)}
    .status-dot.up{background: linear-gradient(180deg,#22d59a,#00bf74); box-shadow:0 6px 18px rgba(0,255,156,0.08)}
    .status-dot.down{background: linear-gradient(180deg,#ff7b7b,#ff4b4b);}

    /* RIGHT PANEL: log & debug */
    .panel {
      width:360px;padding:18px;border-radius:var(--card-radius);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
      border:1px solid rgba(255,255,255,0.02);box-shadow:0 12px 40px rgba(0,0,0,0.65);
    }

    .log {
      height:420px;overflow:auto;padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.4));
      font-family:'Share Tech Mono', monospace;font-size:12px;border:1px solid rgba(0,255,156,0.03);
    }

    .log .line{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.02)}
    .log .time{font-size:11px;color:#9ee9c8;margin-right:8px}
    .line .detail{display:block;margin-top:6px;color:#dfffe8;font-size:12px;word-break:break-word}

    /* modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:50}
    .overlay.show{display:flex}
    .modal{width:420px;background:#000;border-radius:12px;padding:18px;border:1px solid rgba(0,255,156,0.06)}
    .modal h3{margin:0;color:var(--accent);font-size:16px}

    /* small utilities */
    .small{font-size:12px;color:#9fdfc8}
    .muted-2{color:#8ae6c3;font-size:12px}
    .pairing {font-family:'Share Tech Mono';font-size:20px;letter-spacing:3px;color:#fff;margin-top:10px}

    /* animation */
    @keyframes pulseGlow {
      0%{box-shadow:0 0 0 rgba(0,255,156,0.06)}
      50%{box-shadow:0 0 36px rgba(0,255,156,0.06)}
      100%{box-shadow:0 0 0 rgba(0,255,156,0.06)}
    }
    .glow{animation:pulseGlow 3s infinite}

    /* responsive */
    @media (max-width:880px){
      .grid{grid-template-columns:1fr; padding: 12px}
      .card,.panel{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <!-- LEFT: controls -->
      <div class="card">
        <div class="title">
          <div class="logo glow" aria-hidden="true">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="2" y="2" width="20" height="20" rx="4" fill="url(#g)"/>
              <defs>
                <linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#001f12"/><stop offset="1" stop-color="#004127"/></linearGradient>
              </defs>
            </svg>
          </div>
          <div>
            <h1>XCVI SIMILARITY</h1>
            <div class="muted">Wanz Official — WhatsApp panel bridge</div>
          </div>
        </div>

        <div class="meta-row">
          <div class="pill small" id="domainShow">Domain: -</div>
          <div class="pill small" id="portShow">Port: -</div>
          <div style="flex:1"></div>
          <div class="pill small" id="versionShow">v1.0</div>
        </div>

        <div class="status" style="margin-top:16px">
          <div class="status-left">
            <div id="statusDot" class="status-dot"></div>
            <div>
              <div id="serverStatusText"><strong>Server:</strong> mengecek...</div>
              <div class="muted-2" id="serverDetail">—</div>
            </div>
          </div>
          <div id="statusAction" style="text-align:right">
            <button class="btn" id="btnRefresh">Refresh</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:14px 0">

        <label>Nama Session</label>
        <input id="nameInput" placeholder="contoh: wanz">

        <label>Nomor (format internasional tanpa +)</label>
        <input id="phoneInput" placeholder="628xxxxxxxx">

        <div class="row">
          <button class="btn btn-primary" id="btnConnect">Connect</button>
          <button class="btn btn-ghost" id="btnDisconnect" style="display:none">Disconnect</button>
          <button class="btn" id="btnSessions">Lihat Sessions</button>
        </div>

        <div id="pairingArea" style="margin-top:12px;display:block">
          <div class="small">Status</div>
          <div class="code-block">
            <div id="statusPill">idle</div>
            <div class="pairing" id="pairingCode">—</div>
          </div>
          <div style="margin-top:8px" class="small">Tips: jika pairing tidak muncul, buka WhatsApp → chat dengan nomor yang terdaftar dan masukkan kode pairing.</div>
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:14px 0">

        <label>Nomor Tujuan</label>
        <input id="sendTo" placeholder="628xxxxxxxx">
        <label>Pesan</label>
        <textarea id="sendText" placeholder="Halo dari panel..."></textarea>

        <div class="row" style="margin-top:10px">
          <button class="btn btn-primary" id="btnSend">Kirim Pesan</button>
          <button class="btn" id="btnClearLog">Clear Log</button>
        </div>
      </div>

      <!-- RIGHT: debug log -->
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700;color:var(--accent)">Console & Diagnostics</div>
            <div class="small">Logs, raw errors, and detailed HTTP traces</div>
          </div>
          <div style="text-align:right">
            <div class="small">Mode: <span id="modeLabel">—</span></div>
            <div class="small">Base: <span id="baseLabel">—</span></div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="log" id="logBox" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- modal overlay -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Info</h3>
      <div id="modalBody" style="margin-top:10px;color:#dfffe8;font-size:13px"></div>
      <div style="margin-top:12px;text-align:right">
        <button class="btn btn-primary" id="modalClose">Tutup</button>
      </div>
    </div>
  </div>

  <!-- Wanzdev config (external) -->
  <script src="./wanzdev.js"></script>

  <!-- main script -->
  <script>
    /* ========= helper UI & logging ========= */
    const $ = s => document.querySelector(s);
    const logBox = $('#logBox');

    function now() {
      return new Date().toISOString().replace('T',' ').split('.')[0];
    }

    function appendLog(title, detail, level='info') {
      const div = document.createElement('div');
      div.className = 'line';
      const t = document.createElement('div');
      t.className = 'time';
      t.textContent = `[${now()}] ${title}`;
      const d = document.createElement('div');
      d.className = 'detail';
      d.innerHTML = detail || '';
      if (level === 'error') {
        d.style.color = '#ffd2d2';
        title = 'ERROR: ' + title;
      }
      div.appendChild(t);
      div.appendChild(d);
      logBox.prepend(div);
    }

    function showModal(title, body) {
      $('#modalTitle').textContent = title;
      $('#modalBody').innerHTML = body;
      $('#overlay').classList.add('show');
    }
    $('#modalClose').onclick = ()=>$('#overlay').classList.remove('show');

    function setStatus(up, text, detail) {
      const dot = $('#statusDot');
      const txt = $('#serverStatusText');
      const det = $('#serverDetail');

      if (up) {
        dot.classList.remove('down'); dot.classList.add('up');
      } else {
        dot.classList.remove('up'); dot.classList.add('down');
      }
      txt.innerHTML = `<strong>Server:</strong> ${text}`;
      det.textContent = detail || '';
    }

    // display domain/port and mode
    $('#domainShow').textContent = 'Domain: ' + (WANZ_CONFIG.domain || '-');
    $('#portShow').textContent = 'Port: ' + (WANZ_CONFIG.port || '(proxy)');
    $('#modeLabel').textContent = (WANZ_CONFIG.port ? 'Direct' : 'Proxy');
    $('#baseLabel').textContent = Wanzdev.getBase() || '(none)';

    /* ========= smart status checker ========= */
    let lastStatus = null;

    async function updateServerStatus() {
      const base = Wanzdev.getBase();
      if (!base) {
        setStatus(false, 'domain kosong', 'Atur WANZ_CONFIG.domain di wanzdev.js');
        appendLog('Status check', 'WANZ_CONFIG.domain belum diatur', 'error');
        return;
      }

      const url = base.replace(/\/+$/, '') + '/';
      appendLog('Pinging server', `GET ${url}`);
      try {
        const controller = new AbortController();
        const timeout = setTimeout(()=>controller.abort(), Wanz_CONFIG.timeout || 5000);
        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(timeout);

        const text = await res.text();
        // try parse JSON
        try {
          const json = JSON.parse(text);
          if (json?.success) {
            setStatus(true, 'terhubung ✅', JSON.stringify(json.creator ? {creator:json.creator, message:json.message} : {}));
            appendLog('Status OK', `HTTP ${res.status} — ${JSON.stringify(json)}`);
            lastStatus = { ok:true, json };
            return;
          } else {
            setStatus(false, 'respons tidak valid', `HTTP ${res.status}`);
            appendLog('Status non-json/invalid', `HTTP ${res.status} — ${text}`, 'error');
            showModal('Respons tidak valid', `<pre style="white-space:pre-wrap;max-height:200px;overflow:auto">${escapeHtml(text)}</pre>`);
            return;
          }
        } catch (e) {
          // not JSON (show detail)
          setStatus(false, 'respons bukan JSON', `HTTP ${res.status}`);
          appendLog('Respons bukan JSON', `HTTP ${res.status} — ${text}`, 'error');
          showModal('Respons bukan JSON', `<pre style="white-space:pre-wrap;max-height:220px;overflow:auto">${escapeHtml(text)}</pre>`);
        }
      } catch (err) {
        const reason = err.name === 'AbortError' ? 'TIMEOUT' : err.message;
        setStatus(false, 'gagal hubungi server ❌', reason);
        appendLog('Network error', `Gagal menghubungi server: ${reason}`, 'error');
      }
    }

    function escapeHtml(str) {
      return (''+str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    // initial status
    updateServerStatus();

    $('#btnRefresh').onclick = updateServerStatus;

    /* ========= API actions (connect / send / disconnect / sessions) ========= */
    let connectedName = null;

    async function apiCallWrapper(fn, args = []) {
      try {
        const res = await fn(...args);
        // if res is not object, show raw
        if (!res || typeof res !== 'object') {
          appendLog('API Raw', `Response: ${String(res)}`, 'error');
          return res;
        }
        if (res.success) appendLog('API OK', JSON.stringify(res));
        else appendLog('API ERROR', JSON.stringify(res), 'error');
        return res;
      } catch (e) {
        appendLog('Exception', e.message, 'error');
        throw e;
      }
    }

    $('#btnConnect').onclick = async () => {
      const name = $('#nameInput').value.trim();
      const phone = $('#phoneInput').value.trim();
      if (!name || !phone) { showModal('Error', 'Isi nama & nomor dulu.'); return; }

      appendLog('Connect', `Meminta pairing untuk ${name} → ${phone}`);
      try {
        const res = await apiCallWrapper(Wanzdev.connect, [name, phone]);
        if (res?.pairing_code) {
          connectedName = name;
          $('#statusPill').textContent = 'Menunggu pairing...';
          $('#pairingCode').textContent = res.pairing_code;
          $('#btnConnect').style.display='none';
          $('#btnDisconnect').style.display='inline-block';
          showModal('Pairing Code', `<div style="font-family:'Share Tech Mono';font-size:20px">${escapeHtml(res.pairing_code)}</div><div style="margin-top:8px">Masukkan kode di WhatsApp dalam 1 menit.</div>`);
        } else {
          const message = res?.message || res?.detail || 'Koneksi gagal';
          showModal('Gagal', `<pre>${escapeHtml(JSON.stringify(res, null, 2))}</pre>`);
        }
      } catch (e) {
        showModal('Exception', escapeHtml(e.message));
      }
    };

    $('#btnDisconnect').onclick = async () => {
      if (!connectedName) { showModal('Info', 'Belum ada session aktif.'); return; }
      try {
        const res = await apiCallWrapper(Wanzdev.disconnect, [connectedName]);
        if (res?.success) {
          appendLog('Disconnect', `Session ${connectedName} dihapus.`);
          $('#statusPill').textContent = 'idle';
          $('#pairingCode').textContent = '—';
          $('#btnDisconnect').style.display='none';
          $('#btnConnect').style.display='inline-block';
          connectedName = null;
          showModal('Sukses', 'Session dihapus permanen.');
        } else {
          showModal('Gagal', escapeHtml(JSON.stringify(res, null, 2)));
        }
      } catch (e) { showModal('Exception', escapeHtml(e.message)); }
    };

    $('#btnSend').onclick = async () => {
      if (!connectedName) { showModal('Error', 'Connect dulu.'); return; }
      const to = $('#sendTo').value.trim();
      const text = $('#sendText').value.trim();
      if (!to || !text) { showModal('Error', 'Isi nomor & pesan.'); return; }

      appendLog('Send', `Mengirim pesan ke ${to}`);
      try {
        const res = await apiCallWrapper(Wanzdev.sendMessage, [connectedName, to, text]);
        if (res?.success) {
          appendLog('Send OK', `Pesan terkirim ke ${to}`);
          showModal('Terkirim', 'Pesan berhasil dikirim.', );
        } else {
          showModal('Gagal kirim', `<pre>${escapeHtml(JSON.stringify(res, null, 2))}</pre>`);
        }
      } catch (e) {
        showModal('Exception', escapeHtml(e.message));
      }
    };

    $('#btnSessions').onclick = async () => {
      try {
        const res = await apiCallWrapper(Wanzdev.listSessions, []);
        if (res?.success) {
          const list = (res.sessions || []).map(s => `<li>${escapeHtml(s)}</li>`).join('') || '<i>Kosong</i>';
          showModal('Daftar Sessions', `<ul style="max-height:240px;overflow:auto">${list}</ul>`);
        } else {
          showModal('Gagal ambil sessions', `<pre>${escapeHtml(JSON.stringify(res, null, 2))}</pre>`);
        }
      } catch (e) { showModal('Exception', escapeHtml(e.message)); }
    };

    $('#btnClearLog').onclick = ()=> logBox.innerHTML = '';

    // Auto-refresh status every 30s
    setInterval(updateServerStatus, 30000);
  </script>
</body>
            </html>
